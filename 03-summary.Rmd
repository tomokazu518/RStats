# データの要約1（記述統計量）

データを入手したら分析を行う前にデータの概観を把握することが重要である。データフレームにどのような変数が含まれているかを確認し，それぞれの変数の記述統計量(平均値，分位点，分散など)を求め，必要であれば変数間の相関関係を調べよう。

ここでは，Rのパッケージ，tidyverseとstargazerを利用するので読み込んでおく。

```{r}
library(tidyverse)
library(stargazer)
```

## データの概観

ここでは，練習としてRに組み込まれているサンプル・データirisを使ってデータを概観する。まず，サンプル・データをirisというデータフレームに読み込む。

```{r}
iris <- iris
```

irisデータには，150のアヤメについて，種類(3分類)，萼片(がくへん)の長さと幅，花弁(かべん)の長さと幅の5つの変数が記録されている。

|変数名|説明|
|-|-|
|Sepal.Length|萼片の長さ|
|Sepal.Width|萼片の幅|
|Petal.Length|花弁の長さ|
|Petal.Width|花弁の幅|
|Species|アヤメの種類|

データにどのような変数が含まれているかは，スプレッド・シートを表示させれば把握できるが，glimpse()関数を使っても良い(tidyverseの読み込みが必要)。

```{r}
glimpse(iris)
```

データの行数(観測数)が150，列数(変数の数)が5であることがわかる。また，5つの変数のはじめのいくつかの観測値を見ることができるので，データのイメージがつかめる。\<dbl\>や\<fct\>はそれぞれの変数の型で，dblは実数型，fctはファクター型であることを表している。変数の型には，ほかに文字列型\<chr\>，整数型\<int\>などがある。

## 要約統計表の作成

データ全体のイメージがつかめたら，次は記録されている変数の要約統計表を作成してみよう。summary()関数を用いれば，データフレームに含まれるすべての変数の要約統計量を表示させることができる。

```{r}
summary(iris)
```

数値型の変数については，最小値(Min.)，第一四分位(1st Qu.)，中央値(Median)，平均値(Mean)，第三四分位(3rd Qu.)，最大値(Max)が表示される。また，ファクター型の変数については，度数分布表が表示される。

これでも十分だが，要約統計量を求める変数や，求める要約統計量をカスタマイズしたい場合には，summarize()関数を用いる。

```{r}
summarize(iris, 
          萼片長平均     = mean(Sepal.Length),
          萼片長標準偏差 = sd(Sepal.Length),
          花弁長平均     = mean(Petal.Length),
          花弁長標準偏差 = sd(Petal.Length)
          )
```

summarize()関数の第1引数にはデータフレーム名を指定する。第2引数以降は要約統計量の名前と対象の変数名を，名前=関数(変数名)という形式で指定する。名前は表示名なので自由に指定すれば良い。関数の部分には，例として下の表のような関数が利用できる。変数名xには，データフレーム内の変数名を指定すればよく，データフレーム名は必要ない。

|関数|説明|
|-|-|
|mean(x)|xの平均値|
|var(x)|xの分散|
|sd(x)|xの標準偏差|
|max(x)|xの最大値|
|median(x)|xの中央値|
|min(x)|xの最小値|
|quantile(x, XX)|xのXX×100パーセンタイル, e.g. xの25パーセンタイルであればquantile(x,0.25)|

summarize()関数は，後で述べるようにグループ別の集計のときに役に立つ。

レポートや論文に貼り付けるための要約統計表を作成するには，stargazerパッケージを用いると良い。

```{r}
stargazer(iris, type = "text", title = "要約統計表", digits = 2,
          summary.stat = c("mean", "sd", "min", "p25", "median", "p75", "max"))
```

stargazer()関数は，要約統計表や回帰分析の結果などを，良い感じの見た目で出力してくれる。

stargazer()関数で要約統計表を作成する場合は，第1引数としてデータフレーム(この例ではiris)を指定する。そのほかの引数は必要に応じて指定すれば良い。よく使うオプションだけ説明する。まず，typeは表の出力形式で，"text"(プレーンテキスト)，"html"，"latex"のいずれかを指定する。titleは表のタイトル，digitsは表の数値の小数点以下の桁数を指定する。summary.statsは表に含める要約統計量をベクトル形式で指定する。

|要約統計量|指定方法|
|-|-|
|平均|mean|
|標準偏差|sd|
|最小値|min|
|最大値|max|
|XXパーセンタイル(分位点)|pXX|

## 相関表

次に，変数間の相関を求めよう。相関表を求めるにはcor()関数を使う。引数にはデータフレーム名を指定する。ただし，irisにファクター型のSpeciesという変数が含まれているため，そのままではエラーになる。そこで，まずデータフレームirisから数値型の4つの変数だけを取り出したデータフレームiris2を作成する。

```{r}
iris2 <- select(iris, - Species)
```

select()は，データフレームから指定した変数を残したデータフレームを作成する関数である。第1引数には取り出したい変数が含まれるデータフレームを指定する。第2引数以降は取り出したい変数名をカンマで区切って指定する。たとえば，select(dataframe,a,b)はdataframe\$aとdataframe\$bの2つの変数が含まれるデータフレームとなる。逆にデータフレームから指定した変数を除外したいときには，第2変数以降に変数名に"-"をつけて指定する。たとえば，select(dataframe,-a)はdataframeから変数aを除いたデータフレームとなる。また，変数は列番号で指定することも可能である。たとえば，select(dataframe,2:4)はdataframeから2列目から4列目までの変数を取り出したデータフレームとなる。

ここでは，irisに含まれる5つの変数のうち数値型の4つを取り出して相関表を作成したいので，ファクター型の変数Speciesだけを除外したiris2を作成している。cor()関数の引数に，iris2を指定すると，相関行列が得られる。

```{r}
cor(iris2)
```

わざわざ新しいデータフレームを作成せずに，以下のように書いても同じ結果が得られる。

```{r}
cor(select(iris, - Species))
```

ほかにも，以下のようなコードでも同じ結果が得られる。入力の簡単さやコードの見た目のわかりやすさで，その都度書き方を考えよう。

```{r eval=FALSE}
cor(select(iris,1:4))
cor(select(iris, Sepal.Length, Sepal.Width, Petal.Length, Petal.Width)
```

## グループ分け

データをグループに分けて，グループごとに要約統計を求めることは，実際に良く行う作業である。irisデータでは，アヤメはsetosa，versicolor，virginicaの3種類に分類されている。アヤメの種類ごとに萼片と花弁の長さ，幅の平均を求めてみよう。そのための方法はいくつか考えられる。

### データフレームを分割する

まず，データフレームをアヤメの種類ごとに分割する方法。単純でわかりやすいが，分類が多くなると大変になる。

アヤメの種類ごとのデータフレームを作成するには，filter()関数を用いる。filter()はデータフレームから条件を満たすデータ(行)を取り出す関数で，第1引数にはデータフレーム名，第2引数には抽出条件を指定する。

```{r}
iris_setosa <- filter(iris, Species == "setosa")
iris_versicolor <- filter(iris, Species == "versicolor")
iris_virginica <- filter(iris, Species == "virginica")
```

アヤメの種類ごとのデータフレームができるので，それぞれのデータフレームで要約統計表を作成する。

```{r}
stargazer(iris_setosa, type = "text", title = "setosa", digits = 2,
          summary.stat = c("mean", "sd", "min", "p25", "median", "p75", "max"))

stargazer(iris_versicolor, type = "text", title = "versicolor", digits = 2,
          summary.stat = c("mean", "sd", "min", "p25", "median", "p75", "max"))

stargazer(iris_virginica, type = "text", title = "virginica", digits = 2,
          summary.stat = c("mean", "sd", "min", "p25", "median", "p75", "max"))
```

### group_by()を使う

たぶんこれが標準的で，洗練された方法。

group_by関数を使うと，(Rの内部で)グループに分類されたデータフレームを作成することができる。第1引数には分類したいデータフレーム名，第2引数以降は分類を行うためのファクター型変数を指定する。複数のファクター型変数を指定して，階層的な分類を行うことも可能。グループに分類されたデータフレームにsummarize()関数を適用すると，グループごとの要約統計量が計算される。

```{r}
iris_grouped <- group_by(iris, Species)

summarize(iris_grouped, 
          萼片長平均     = mean(Sepal.Length),
          萼片長標準偏差 = sd(Sepal.Length),
          花弁長平均     = mean(Petal.Length),
          花弁長標準偏差 = sd(Petal.Length)
          )

```

### xtabs()を使う

xtabs()関数を使うと，多次元分割表を柔軟に作成することができる。第1引数には形式を，第2引数にはデータフレーム名を指定する。形式は，`~ x1 + x2 + ...`か`y ~ x1 + x2 + ...`の形で指定する。たとえば，`~ x1 + x2`を指定すれば，x1,x2で表を分割し，各セルの観測数が得られる。`y ~ x1 + x2`を指定すれば，x1,x2で表を分割し，各セルに入るデータのyの合計が得られる。

irisでは分類に用いることができる変数はSpeciesの1つしかないが，それでもxtabs()を適用できる。以下のコードでSpeciesごとのデータ数の表を作成できる。

```{r}
xtabs(~Species, iris)
```

次に，以下のコードでSpeciesごとの萼片長の合計値の表を作成できる。

```{r}
xtabs(Sepal.Length ~ Species, iris)
```

平均値は合計値をデータ数で割ったものなので，Speciesごとの萼片長の平均値を以下のように求められる。

```{r}
xtabs(Sepal.Length ~ Species, iris) / xtabs(~ Species, iris)
```
